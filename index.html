<!DOCTYPE html>
<html>
   <head>
      <title>Subir archivos y procesarlos</title>
      <!-- Agregamos los estilos de Bootstrap -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
      <style>
        .footer{
            z-index: 10000;
            bottom: 0;
            position: fixed;
            width: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .timer{
            z-index: 10000;
            bottom: 0;
            position: fixed;
            width: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin-bottom: 1.6em;
        }
        .header{
    position: sticky;
    background:#fff;
    top: 0;
    left: 0;
    padding-top: 10px;
    z-index: 1000;
    }
    </style>
   </head>
   <body>
      <div class="container">
         <div class="row justify-content-center mt-5">
            <div class="col-md-6" id ="content">
               <h1 class="text-center mb-4">Archivos de usuarios y canales</h1>
               <form method="POST" enctype="multipart/form-data">
                  <div class="form-group">
                     <label for="archivo1">Seleccione un archivo de usuarios:</label>
                     <input type="file" name="archivo1" id="archivo1" class="form-control-file">
                  </div>
                  <div class="form-group">
                     <label for="archivo2">Seleccione un archivo de canales:</label>
                     <input type="file" name="archivo2" id="archivo2" class="form-control-file">
                  </div>
                  <button type="submit" name="submit" class="btn btn-primary btn-block">Subir archivos</button>
               </form>
            </div>
        </div>
        <section>
            <div class="footer" id ="processing"></div>
            <div class ="timer" id="waiting" ></div>
        </section>
      </div>
      <script>
        // Declaramos las variable fuera de la función procesarArchivos
         var idAdmin;
         let emailAdmin;
         let channelsTotal=0;
         let channelsChecked = 0;
         let checkboxes;
         let channelsIDs= [];
         let processedChannels= 0;
         
         function procesarArchivos(event) {
             // Prevenimos el comportamiento predeterminado del evento
             event.preventDefault();
         
             // Obtenemos los archivos seleccionados
             var archivo1 = document.getElementById("archivo1").files[0];
             var archivo2 = document.getElementById("archivo2").files[0];
         
             // Si no se seleccionaron ambos archivos, mostramos un mensaje de error
             if (!archivo1 || !archivo2) {
                 alert("Debe seleccionar ambos archivos para poder procesarlos");
                 return;
             }
         
             // Leemos el contenido del archivo 1
             var lector1 = new FileReader();
             lector1.onload = function (event) {
                 var contenido1 = event.target.result;
                 var datos1 = JSON.parse(contenido1);
         
                 // Buscamos el id del administrador en el archivo 1 y lo almacenamos en la variable idAdmin
                    var admin1 = datos1.find(function (elemento) {
                     return elemento.is_admin === "true";
                 });
                 
                emailAdmin = admin1.email;   
                 idAdmin = admin1.id;
             };
             lector1.readAsText(archivo1);
         
             // Leemos el contenido del archivo 2
             var lector2 = new FileReader();
             lector2.onload = function (event) {
                 var contenido2 = event.target.result;
                 var datos2 = JSON.parse(contenido2);
         
                 // Aquí puedes hacer lo que necesites con los datos del archivo 2 y acceder a la variable idAdmin
                 console.log("Datos del archivo 2:");
                 console.log(datos2);
                 console.log("Id del administrador obtenido del archivo 1:");
                 console.log(idAdmin);
                 let channelsFiltered="";
                 datos2.forEach(channel => {
                 
                      if((channel.members.some(member=> member.id == idAdmin))) {
                         console.log(channel.name+ " " + isArchived(channel));
                         channelsFiltered+=`<div class="form-check">
         <input class="form-check-input" name="checkbox" type="checkbox" value="" id="${channel.id}" checked>
         <label class="form-check-label text-left" for="check${channelsTotal}">${channel.name+ " " + isArchived(channel)}</label>
         </div>`
                         channelsTotal++
                     }
                 });
                 
                 channelsChecked= channelsTotal
                 let header=`<div class="header">
<div class="input-group mb-3">
         <input type="text" class="form-control" placeholder="Token de acceso" aria-label="Recipient's username" aria-describedby="basic-addon2" id ="token">
         <div class="input-group-append">
         <button class="btn btn-outline-secondary" type="button" id ="apiCall">Hacer llamada</button>
         </div>
         </div>
         <div class="col-sm">
         <h4 class="text-center" id ="channelsSelected">${channelsChecked} canales seleccionados de ${channelsTotal}</h4>
         <h4 class="text-center" >Superadmin: ${emailAdmin}</h4>
         </div>
         <div class="form-check">
         <input class="form-check-input" type="checkbox" value="" id="markAll" checked>
         <label class="form-check-label text-left" for="markAll">Seleccionar/desmarcar todos los canales</label>
         <br><br>
         </div>
         </div>
         
         <div style="z-index: 1;">${channelsFiltered}</div>`
                 document.getElementById("content").innerHTML = header;
         
                 checkboxes = document.querySelectorAll("input[name=checkbox]");
                 checkboxes.forEach(checkbox => {
                     checkbox.addEventListener('change', function() {
                 if (this.checked) {
                     channelsChecked++
                     if (channelsChecked == channelsTotal) {
                         document.getElementById("markAll").checked=true
         
                     }
                 } else {
                     channelsChecked--
                     if(channelsChecked==0) {
                         document.getElementById("markAll").checked=false
                     }
                 }
                 currentChannelsChecked()
                 });
                 });
                 
                 document.getElementById("markAll").addEventListener('change',function() {
                         checkboxes.forEach(checkbox => {
                             checkbox.checked= this.checked
                         })
                         if(this.checked) {
                                 channelsChecked= channelsTotal;
                             } else {
                                 channelsChecked= 0
                             }
                             currentChannelsChecked()
                 })

                 //Botón llamada a api
                let buttonRequest= document.getElementById("apiCall")
               buttonRequest.addEventListener('click',function() {
                    let token = document.getElementById("token").value
                    if(token == null || token == "") {
                        alert("¡No se olvide de añadir el token de acceso!")
                        return
                    }
                    //deshabilitamos los caanales/botones para que no hayan problemas
                buttonRequest.disabled = true
                chs = document.querySelectorAll("input[type=checkbox]")
                chs.forEach((check)=> check.disabled= true)

                checkboxes2 = document.querySelectorAll("input[name=checkbox]:checked");
                channelsIDs= []
                checkboxes2.forEach(checkbox => {
                    channelsIDs.push(checkbox.id)
                 })
                 console.log(channelsIDs)
                 makeRequest(0)
         })
             };
             lector2.readAsText(archivo2);

             //Función que pone un contador hasta la siguiente petición de api
           async function setRequestTimer(secondsLeft) {
                const requestTimer = setInterval( 
                () => {
                    if (secondsLeft <= 0) { clearInterval(requestTimer)
                    document.getElementById("waiting").innerHTML="";
                    makeRequest(0)
                    }
                    document.getElementById("waiting").innerHTML="Esperando... "+ secondsLeft
                    secondsLeft -= 1
                }, 
            1000)
            }
            //Función que hace la llamada a API
             async function makeRequest(currentRequests) {
                while(currentRequests<10 && processedChannels < channelsIDs.length) {
                    const response = await fetch("https://cliq.zoho.com/api/v2/channels/"+ channelsIDs[processedChannels]+"/members", {
                        method:'POST', 
                        body: {
                            'email_ids':emailAdmin
                        },
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': `Zoho-oauthtoken ${token}`
                        }
                    })
                    console.log(response)
                    const jsonRespone = await response.json()
                    console.log(jsonRespone)
                    channelsProcessed()
                    currentRequests++
                    processedChannels++
                }
                if(processedChannels < channelsIDs.length) {
                     await setRequestTimer(60)
                }
            }

             //Función para devolver el conteo de procesado de canales
             let channelsProcessed= ()=> {
                document.getElementById("processing").innerHTML= `<div><h5 style="text-align:center;">Procesados ${processedChannels+1} canales de ${channelsIDs.length}...</h5> <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="${processedChannels+1}" aria-valuemin="0" aria-valuemax="${channelsIDs.length}" style="width: ${(processedChannels+1)/channelsIDs.length*100}%"></div>
                    </div>
                    </div>`
             }
             //Función para devolver el estado de archivado del canal
             let isArchived = (channel) => {
                 //variable para convertir el string en boolean
                 let isTrueSet = (channel.sys_archived === 'true')
                 return isTrueSet ? '(Archivado)' : '(No archivado)'
             }
         }
         //Función que actualiza el total de canales seleccionados
         let currentChannelsChecked= ()=> {
             console.log(currentChannelsChecked)
              document.getElementById("channelsSelected").innerHTML= `<h4 class="text-center">${channelsChecked} canales seleccionados de ${channelsTotal}</h4>`
         }
         // Asociamos la función al evento submit del formulario
         document.querySelector("form").addEventListener("submit", procesarArchivos);
         //TODO: PROCESO COMPLETO, response informativa al lado de channels

         
         
         
      </script>
      <!-- Agregamos los scripts de Bootstrap -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   </body>
</html>